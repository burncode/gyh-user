<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>我的訂單</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/pullRefresh.css" />
		<link rel="stylesheet" href="../css/common.css" />
		<link rel="stylesheet" href="../css/pay/confirmCss.css" />
		<link rel="stylesheet" href="../css/order/buy_record.css" />
		<style>
			.mui-table-view-cell:after {
			    left: 0;
			}
			.mui-table-view-cell{
			    margin: 10px 0 0;
			}
			.mui-navigate-right:after{
			    right: 5px;
			}
			.mui-table-view-cell>a:not(.mui-btn){
			    margin: -15px -20px 0;border-bottom: 1px solid #dedede;
			}
			.mui-table-view-cell .price{
			    margin: 10px 0;
			}
			.mui-media-body{
				    padding: 0 10px 0 0;
			}
			.btns{
				    text-align: right;
    				margin: 10px 0 -2px;
			}
			.mui-table-view:after{
				height: 0;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-pull-left mui-action-back mui-icon mui-icon-left-nav"></a>
			<h1 id="title" class="mui-title">我的訂單</h1>	
		</header>
		<div id="mui-scroll-wrapper" class="mui-content mui-fullscreen mui-scroll-wrapper">
			<div id="cases" class="mui-scroll">
				<ul id="buyRecord-list" class="mui-table-view"></ul>
			</div>
		</div>
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/mui.pullToRefresh.min.js"></script>
	<script src="../js/mui.pullToRefresh.material.min.js"></script>
	<script src="../js/common.js"></script>
	<script>
		(function(_,doc,u,w){
			_(".mui-scroll-wrapper").scroll();
			var pdata={offset:0,limit:5};
			var page = 0,li = null,privateToken = null,_pull = null,state = null,orderType = null,imgServer = null;
			var list = doc.getElementById('buyRecord-list');
			var stateClass = "",stateClass_01 = "color_f99",stateClass_02 = "color_f33",btn_display="mui-hidden";
			var payBtn = "",pay = "",cancel = "",cancelBtn = "";
			var payClass = "but",payText = "付款",cancelOrder = "取消",cancelClass = "cancel";
			_.plusReady(function() {
				privateToken = w.getItem("privateToken");
				pdata.privateToken = privateToken;
				_pull = _('#cases').pullToRefresh({
					down: {
						callback: function() {
							pdata.offset = 0;
							u.mypost('user_center/order',pdata, false, function(data) {
								_pull.endPullDownToRefresh((data.data.order || []).length == 5);
								if (data.code == 0) {
									page = 1;
									u.emptyHtml(list), orderList(data.data || []);
								}else{
									_.toast(data.msg || '服務器異常');
								}
							}, function() {
								_.toast('獲取列表失敗'), _pull.endPullDownToRefresh();
							});
						}
					},up: {
						callback: function() {
							pdata.offset=(pdata.limit)*page;
							u.mypost('user_center/order',pdata, false, function(data) {
								_pull.endPullUpToRefresh((data.data.order || []).length < 5);
								if (data.code  == 0) {
									page++;
									orderList(data.data || []);
								} else {
									_.toast(data.msg ||'服務器異常');
								}
							}, function() {
								_.toast('獲取列表失敗'), _pull.endPullUpToRefresh(true);
							});
						},auto: true
					}
				});
			});
			function orderList(data){
				console.log('order data=======' + JSON.stringify(data));
				imgServer = data.imgServer;//图片
				_.each(data.order,function(i,obj){
					li = doc.createElement("li");
					li.id = obj.gid;
					li.orderType = obj.orderType;
					state = obj.status;
					btn_display = "mui-hidden";
					if(state == "未付款"){
						stateClass = stateClass_01;
						payBtn = payClass;
						pay = payText;
						cancel = cancelOrder;
						cancelBtn = cancelClass;
						btn_display = "";
					}else if(state == "已付款"){
						payBtn = "";
						pay = "";
						cancel = "";
						cancelBtn = "";
						stateClass = stateClass_02;
					}else if(state == "完成"){
						payBtn = "";
						pay = "";
						cancel = "";
						cancelBtn = "";
						stateClass = "";
					}
					var img = null;
					img = util.isNull(obj.thumbnail)? "../images/default-record.png":imgServer+obj.thumbnail;
					li.className = "mui-table-view-cell mui-media";
					li.innerHTML = "<a data-arr='"+obj.arrUser+"' class='mui-navigate-right'>"+
							"<img class='mui-media-object mui-pull-left' src='"+img+"'>"+
							"<div class='mui-media-body'><div class='mui-ellipsis packageTitle'>"+obj.packageTitle+"</div><p><span class='price'>¥"+obj.price+"<span class='state mui-pull-right "+stateClass+"'>"+state+"</span></p></div></a>"+
						"<div class='btns "+btn_display+"'><button data='"+obj.orderType+"' class='mui-btn "+cancelBtn+"' id='"+obj.oid+"'>"+cancel+"</button><button data='"+obj.orderType+"' data1="+obj.price+" class='mui-btn "+payBtn+"' id='"+obj.oid+"'>"+pay+"</button></div>";
					list.appendChild(li);
				})
			}
			function getData(){
				mui('#mui-scroll-wrapper').scroll().scrollTo(0,0,100);
				list.innerHTML = "";//清空
				u.mypost('user_center/order',{offset:0,limit:5,privateToken:privateToken}, true, function(data) {
					orderList(data.data);
				},myerror);
			}
			//订单詳情
			_('.mui-table-view').on('tap','.mui-navigate-right',function(){
				var userArr = eval(this.getAttribute("data-arr"));
				var src =  this.querySelector('.mui-media-object').getAttribute('src');
				var packageTitle =  this.querySelector('.packageTitle').innerHTML;
				var price =  this.querySelector('.price').innerHTML;
				var state =  this.querySelector('.state').innerHTML;
				w.openView('buy_record_detail.html',{
					src:src,
					userArr:userArr,
					packageTitle:packageTitle,
					price:price,
					state:state
				});
	    	})
			//付款
			_('.mui-table-view').on('tap','.but',function(e){	  
		      	var order = this.getAttribute("data");
				var price = this.getAttribute("data1");
				var orderId = this.id;
				if(order == "疫苗訂單"){ 
					var ex1 = {
						type:2,
						order_type:"疫苗接種費用",
						orderId:orderId,
						fee:price
					}
			      	w.openView('../doctor/pay.html',ex1);
			      	e.stopPropagation();
				}else if(order == "基因訂單"){
					var ex2 = {
						type:3,
						order_type:"檢測服務专业咨询服务费",
						orderId:this.id,
						fee:price
					}
			      	w.openView('../doctor/pay.html',ex2);
			      	e.stopPropagation();
				}
			})
			//取消订单
			_('.mui-table-view').on('tap','.cancel',function(e){
				e.stopPropagation();
				pdata.privateToken = privateToken;
				pdata.oid = this.id;
				pdata.orderType = 4;
				_.confirm('確定要取消嗎？', '<div class="btn-title">提示</div>',['否', '是'], function(e) {
					if(e.index == 1){
						u.mypost("user_center/orderCancel",pdata,true,function(data){
							if(data.code == 0){
								_.toast("取消成功");
								getData();
							}
						},myerror);
					}
				},'div');
			})
		})(mui,document,util,window)
	</script>
</html>