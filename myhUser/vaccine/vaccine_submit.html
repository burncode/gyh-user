<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="format-detection" content="telephone=no">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>填写资料</title>
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/simple-calendar.css" />
		<link rel="stylesheet" href="../css/vaccine/vaccine_submit.css" />
		<script>
			//检查手机号
			function checkPhone(phone) {
				if(!util.checkPhone(phone)) {
					mui.toast('请正确填写联系电话')
				}
			}
			//检查身份证号
			function checkCardId(val) {
				if(!util.checkIdCard(val)) {
					mui.toast('请正确填写身份证号码')
				}
			}
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">填写资料</h1>
			<button id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right" style="border: 0;">提交</button>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view mui-table-view-chevron" style="margin: 10px;">
				<li class="mui-table-view-cell mui-media" style="padding:10px;border-radius: 6px;">
					<img id="thumbnailImg" class="mui-media-object mui-pull-left" src="../images/default-record.png">
					<div class="mui-media-body">
						<div id="vaccineName">疫苗名称</div>
						<p class="main-font-color">定金: ¥<span id="price">0.00</span></p>
					</div>
				</li>
			</ul>
			<div class="mui-card">
				<ul id="divForm" class="mui-table-view">
					<li class="mui-table-view-cell">
						<div class="mui-slider-right mui-disabled">
							<a class="mui-btn mui-btn-red">删除</a>
						</div>
						<div class="mui-slider-handle">
							<form class="mui-input-group">
								<div class="mui-input-row">
									<label>到诊人</label>
									<input type="text" maxlength="10" class="mui-input-clear name" placeholder="请输入到诊人">
								</div>
								<div class="mui-input-row">
									<label>联系电话</label>
									<input type="tel" maxlength="11" class="mui-input-clear mobile" placeholder="请输入联系电话" onblur="checkPhone(this.value)">
								</div>
								<div class="mui-input-row">
									<label>身份证号</label>
									<input type="tel" class="mui-input-clear identity" maxlength="20" placeholder="到诊人身份证号" onblur="checkCardId(this.value)">
								</div>
								<div id="chooseDate" class="mui-input-row">
									 <label>预约日期</label>
									 <span class="mui-navigate-right"><input type="text" class="mui-input-clear orderDate" placeholder="请选择日期" readonly="readonly"></span>
								</div>
								<div class="mui-input-row">
									 <label>选择时间</label>
									 <span class="mui-navigate-right"><input type="text" class="mui-input-clear appointTimeId" value="12" placeholder="请选择时间" readonly="readonly"></span>
								</div>
							</form>
						</div>
					</li>
				</ul>
			</div>
			<div id="d_btn_add" class="div_btn_add mui-hidden"><button id='addBtn' type="button" class="mui-btn mui-btn-blue mui-icon mui-icon-plus">添加</button></div>
			<div id="time" class="mui-popover mui-popover-action mui-popover-bottom">
				<div id='calendar'></div>
			</div>
		</div>
	</body>
	<script src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/simple-calendar.js"></script>
	<script src="../js/common.js"></script>
	<script>
		(function(_, doc, u, w) {
			_.init(), _(".mui-scroll-wrapper").scroll();
			var vaccinumId = null,
				inputItmems = null,
				thumbnailImg = '';
			var arrUser = [],
				pdata = {}; //用户信息数组
			var user = {},
				len = 0,
				userNum = 1; //用户对象   数量
			var thisOrderDate = null;
			var divFormObj = document.getElementById("divForm"),
				submitObj = document.getElementById("submit"),
				priceObj = document.getElementById("price"),
				thumbnailImgObj = document.getElementById("thumbnailImg"),
				vaccineNameObj =  document.getElementById("vaccineName");
			var d_btn_addObj = document.getElementById("d_btn_add"),calendarObj = document.getElementById("calendar");
			var markObj = {
							'2018-1-4':'预约',
							'2018-1-26':'预约',
							'2018-2-5':'预约',
							'2018-3-15':'预约'
						},oTime = '';
						var myCalendar = new SimpleCalendar('#calendar');
						myCalendar.addMark(markObj); 
//			getAppointTimeByMonth();
			getAppointTimeByDay('20180131');
			
			function getAppointTimeByMonth(ym){
				var pdata={}
				pdata.privateToken = w.getItem("privateToken");
				pdata.ym = ym;
				console.log(JSON.stringify(pdata));
				u.mypost("appointMap/getAppointTimeByMonth", pdata, true, function(data) {
					console.log('getAppointTimeByMonth data=====' + JSON.stringify(data));
					if(data.code == 0) {
						_.each(data.data[0],function(i,o){
						 	 oTime = formatTime(o.appointYM,o.appointDay);
						 	 markObj[oTime] = '预约';
						})
						var myCalendar = new SimpleCalendar('#calendar');
						myCalendar.addMark(markObj); 
						console.log("arrAppTimeYM===" + JSON.stringify(markObj));
					} else if(data.code == 500 && '未登錄' == data.msg) {
					}
				}, myerror);
			}
			
			
			function getAppointTimeByDay(day){
				var pdata={};
				pdata.privateToken = w.getItem("privateToken");
				pdata.day = day;
				console.log(JSON.stringify(pdata));
				u.mypost("appointMap/getAppointTimeByDay", pdata, true, function(data) {
					console.log('getAppointTimeByDay data=====' + JSON.stringify(data));
					if(data.code == 0) {
//						_.each(data.data[0],function(i,o){
//						 	 oTime = formatTime(o.appointYM,o.appointDay);
//						 	 markObj[oTime] = '预约';
//						})
						var myCalendar = new SimpleCalendar('#calendar');
						myCalendar.addMark(markObj);
						console.log("arrAppTimeYM===" + JSON.stringify(markObj));
					} else if(data.code == 500 && '未登錄' == data.msg) {
					}
				}, myerror);
			}
			
			//格式化时间
			function formatTime(timeStr,dayStr){
				return timeStr.substr(0,4) + '-' + Number(timeStr.substr(4,2) || 1) + '-' + dayStr;
			}
			
			w.addEventListener("event", function(e) {
				if(w.getItem('role') == '代理人'){
					removeClass(d_btn_addObj,'mui-hidden');
				}else{
					addClass(d_btn_addObj,'mui-hidden');
				}
				vaccinumId = e.detail.vaccinumId;
				name = e.detail.name;
				price = (e.detail.price) * userNum;
				thumbnailImg = e.detail.thumbnailImg || '../images/default-record.png';
				thumbnailImgObj.setAttribute('src', thumbnailImg);
				priceObj.innerHTML = price;
				vaccineNameObj.innerHTML = name;
			})

			//添加接种人信息
			document.getElementById("addBtn").addEventListener('tap', function() {
				inputItmems = divFormObj.querySelectorAll('input');
				if(inputItmems && inputItmems.length > 0) {
					for(var i = 0; i < inputItmems.length; i++) {
						var vObj = inputItmems[i];
						if(u.isNull(vObj.value)) {
							_.toast('请补充完整到诊人信息');
							return;
						} else if(hasClass(vObj, 'mobile')) {
							if(!util.checkPhone(vObj.value)) {
								_.toast('请正确填写联系电话');
								return;
							}
						} else if(hasClass(vObj, 'identity')) {
							if(!util.checkIdCard(vObj.value)) {
								mui.toast('请正确填写身份证号码');
								return;
							}
						}
					}
				}
				var liItem = document.createElement('li');
				liItem.classList = 'mui-table-view-cell';
				liItem.innerHTML = '<div class="mui-slider-right mui-disabled">' +
					'<a class="mui-btn mui-btn-red">删除</a>' +
					'</div>' +
					'<div class="mui-slider-handle">' +
					'<form class="mui-input-group">' +
					'<div class="mui-input-row">' +
					'<label>到诊人</label>' +
					'<input type="text"  maxlength="10" class="mui-input-clear name" placeholder="请输入到诊人">' +
					'</div>' +
					'<div class="mui-input-row">' +
					'<label>联系电话</label>' +
					'<input type="tel" maxlength="11" class="mui-input-clear mobile" placeholder="请输入联系电话" onblur="checkPhone(this.value)">' +
					'</div>' +
					'<div class="mui-input-row">' +
					'<label>身份证号</label>' +
					'<input type="tel" class="mui-input-clear identity" maxlength="20" placeholder="到诊人身份证号" onblur="checkCardId(this.value)">' +
					'</div><div id="chooseDate" class="mui-input-row">' +
					'<label>预约日期</label>' +
					'<span class="mui-navigate-right"><input type="text" class="mui-input-clear orderDate" placeholder="请选择日期" readonly="readonly"></span>' +
					'</div>' +
					'</form>' +
					'</div>';
				divFormObj.appendChild(liItem);
				userNum++;
				priceObj.innerHTML = price * userNum;
			})

			//提交
			submitObj.addEventListener('tap', function() {
				inputItmems = divFormObj.querySelectorAll('input');
				if(inputItmems && inputItmems.length > 0) {
					for(var i = 0; i < inputItmems.length; i++) {
						if(u.isNull(inputItmems[i].value)) {
							_.toast('请补充完整到诊人信息');
							return;
						}
					}
				}

				var names = document.getElementsByClassName('name');
				var mobiles = document.getElementsByClassName('mobile');
				var identity = document.getElementsByClassName('identity');
				var appointTimeId = document.getElementsByClassName('appointTimeId');
//				var orderDate = document.getElementsByClassName('orderDate');

				arrUser = [];
				len = 0;
				len = names.length || 0;
				for(var i = 0; i < len; i++) {
					user = {};
					user.name = names[i].value;
					user.mobile = mobiles[i].value;
					user.identity = identity[i].value;
					user.appointTimeId = appointTimeId[i].value;
//					user.orderDate = orderDate[i].value;
					arrUser.push(user);
				}
				console.log('arrUser=====' + JSON.stringify(arrUser));

				pdata.privateToken = w.getItem("privateToken");
				pdata.vaccinumId = vaccinumId;
				pdata.arrUser = JSON.stringify(arrUser);
				u.mypost("vaccinum/payView", pdata, true, function(data) {
					console.log('payView data=====' + JSON.stringify(data));
					if(data.code == 0) {
						orderId = data.data.orderId;
						var ex = {
							type: 2,
							order_type: "疫苗接種定金",
							orderId: orderId,
							fee: data.data.price
						}
						w.openView("../doctor/pay.html", ex); //1代表直接支付，并跳转到購買成功
					} else if(data.code == 500 && '未登錄' == data.msg) {
						w.openView("../userLogin.html");
					}
				}, myerror);
			})

			var yearObj = document.getElementById("select-year"),
				monthObj = document.getElementById("select-month")
			//点击预约
			_('#calendar').on('tap', '.sc-item', function() {
				thisOrderDate.value = yearObj.value + '-' + monthObj.value + '-' + this.querySelector('.day').innerHTML;
				_('#time').popover('toggle');
			})
			//点击选择时间
			_('#divForm').on('tap', '.orderDate', function() {
				thisOrderDate = this;
				_('#time').popover('toggle');
			})

			_('#divForm').on('tap', '.mui-btn', function(event) {
				var elem = this;
				var li = elem.parentNode.parentNode;
				_.confirm('确认删除该条记录？', '提示', ['确认', '取消'], function(e) {
					if(e.index == 0) {
						li.parentNode.removeChild(li);
						userNum--;
						priceObj.innerHTML = price * userNum;
					} else {
						_.swipeoutClose(li);
					}
				});
			});
		})(mui, document, util, window)
	</script>

</html>