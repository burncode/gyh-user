<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>vue shopping cart</title>
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/common.css" />
		<link rel="stylesheet" href="../css/shop/cart.css">
	</head>

	<body>
		<div id="app">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">購物車</h1>
				<span class="mui-pull-right mui-btn-link" @tap="toggleDelBtn">
                    <span v-show="!delFlag">编辑</span>
				<span v-show="delFlag">完成</span>
				</span>
			</header>
			<div class="mui-content">
				<div class='noContent' v-if="cart.length === 0">
					<div class='mui-icon iconfont icon-comiiszanwushuju'></div>
					<div>裡面暫無商品喲</div>
				</div>
				<ul class="mui-table-view cart-list" v-else>
					<li class="mui-table-view-cell mui-media" v-for="(item, index) in cart">
						<div class="mui-pull-left">
							<div class="mui-input-row mui-checkbox mui-left" @tap="selectGoods(item)">
								<label><img class="mui-media-object" v-bind:src="item.img"></label>
								<input name="checkbox" value="item.id" type="checkbox" v-model="item.checked">
							</div>
						</div>
						<div class="mui-media-body">
							<p class="mui-ellipsis-2">{{item.name}}</p>
							<div class="price-div">
								<span class="main-font-color">¥{{item.price}}</span>
								<div class="mui-numbox mui-pull-right" data-numbox-min='1' data-numbox-max="99">
									<button class="mui-btn mui-btn-numbox-minus" type="button" @tap="changeQty(false, item)">-</button>
									<input class="mui-input-numbox" type="number" maxlength="2" v-model="item.quantity" />
									<button class="mui-btn mui-btn-numbox-plus" type="button" @tap="changeQty(true, item)">+</button>
								</div>
							</div>
						</div>
					</li>
				</ul>
			</div>
			<nav class="mui-bar mui-bar-tab" v-bind:class="{ 'del-box': delFlag }">
				<div class="mui-pull-left all-choose">
					<div class="mui-input-row mui-checkbox mui-left" @tap="checkAll">
						<label class="font-size-14">全选</label>
						<input name="checkbox" value="" type="checkbox" v-model="checkAllFlag">
					</div>
				</div>
				<div class="action-btn buy-btn" @tap="toConfirm">结算</div>
				<div class="action-btn del-btn" @tap="delGoods">删除({{ selectedNum }})</div>
				<div class="total">合计：<span>¥<b>{{ totalPrice }}</b></span></div>
			</nav>
		</div>
	</body>
	<script type="text/javascript" src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/vue.min.js"></script>
	<script type="text/javascript" src="../js/common.js"></script>
	<script>
		var Cart = new Vue({
			el: '#app',
			data: {
				checkAllFlag: false,
				selectedNum: 0,
				delFlag: false,
				cart: [{
					id: 1001,
					name: 'Dysport丽舒妥——新型肉毒杆菌',
					price: 558,
					type: 4,
					quantity: 1,
					subtotal: 558,
					stock: 558,
					checked: false,
					sales: 1872,
					img: '../images/1.jpg'
				}, {
					id: 1001,
					name: 'Dysport丽舒妥——新型肉毒杆菌',
					price: 515,
					type: 4,
					quantity: 1,
					subtotal: 515,
					stock: 515,
					checked: false,
					sales: 1872,
					img: '../images/1.jpg'
				}, {
					id: 1001,
					name: 'Dysport丽舒妥——新型肉毒杆菌',
					price: 5100,
					type: 4,
					quantity: 1,
					subtotal: 5100,
					stock: 5100,
					checked: false,
					sales: 1872,
					img: '../images/1.jpg'
				}, {
					id: 1001,
					name: 'Dysport丽舒妥——新型肉毒杆菌',
					price: 558,
					type: 4,
					quantity: 1,
					subtotal: 558,
					stock: 558,
					checked: false,
					sales: 1872,
					img: '../images/1.jpg'
				}]
			},
			methods: {

				/**
				 * @method 增减单品数量
				 * @param {Boolean} isAdd 是否增加
				 * @param {Number} index 商品下标
				 */
				changeQty: function(isAdd, item) {
					var num = item.quantity,
						stock = item.stock;

					if(isAdd && num < stock) {
						this.$set(item, 'quantity', ++num);
					} else if(!isAdd && num > 1) {
						this.$set(item, 'quantity', --num);
					}

					this.$set(item, 'subtotal', (item.price * num).toFixed(1));
				},

				/**
				 * @method 选择商品
				 * @param {Object} item 商品对象
				 */
				selectGoods: function(item) {
					// 状态值取反，并根据状态值对selectedNum进行加减
					item.checked = !item.checked;
					item.checked ? ++this.selectedNum : --this.selectedNum;
					// 设置全选
					this.selectedNum === this.cart.length ?
						this.checkAllFlag = true :
						this.checkAllFlag = false
				},

				/**
				 * @method 全选
				 */
				checkAll: function() {
					var self = this;
					this.checkAllFlag = !this.checkAllFlag;

					this.cart.forEach(function(item) {
						if(self.checkAllFlag) {
							// 全选
							item.checked = true;
							self.selectedNum = self.cart.length;
						} else {
							// 取消全选
							item.checked = false;
							self.selectedNum = 0;
						}
					});
				},

				/**
				 * @method 切换删除按钮
				 */
				toggleDelBtn: function() {
					this.delFlag = !this.delFlag;
				},

				/**
				 * @method 删除商品
				 */
				delGoods: function() {
					/**
					 * !提示：
					 * 每次遍历删除数组元素时，会减少数组长度，所以不能缓存length
					 * 也不能用forEach方法，因为它会自动缓存数组的长度
					 * 这里还可以用filter
					 */
					var cart = this.cart;
					this.cart = cart.filter(function(item) {
						return !item.checked
					});
					// for (var i = 0; i < cart.length; i++) {
					//     cart[i].checked && cart.splice(i--, 1);
					// };

					// 重置 被选商品数量、全选状态、删除状态
					this.selectedNum = 0;
					this.checkAllFlag = false;
					this.delFlag = !this.delFlag;
				},
				toConfirm:function(){
					if(this.totalPrice > 0){
						window.openView("confirmOrder.html");
					}else{
						mui.toast("請選擇所要購買的商品")
					}
				}

			},
			computed: {
				/**
				 * @method 已选商品的总额
				 */
				totalPrice: function() {
					var num = 0;
					this.cart.forEach(function(item) {
						item.checked && (num += parseFloat(item.subtotal));
					});
					return num;
				}
			}
		});
	</script>

</html>